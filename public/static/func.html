<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funcionário</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../styles/style_func.css">
    <link rel="shortcut icon" href="../assets/sinal-de-reciclagem.png" type="image/x-icon"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <a href="./index.html" style="text-decoration: none;"><i class="fas fa-recycle"></i></a>
                <a href="./index.html" id="logo_link" style="all: unset; cursor: pointer;"><span id="logo_span">Reciclagem Express</span></a>
            </div>
            <nav id="employeeNav" style="display:none;">
                <ul>
                    <li><a href="#"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="#coletas"><i class="fas fa-tasks"></i> Minhas Coletas</a></li>
                    <li><a href="index.html"><i class="fas fa-history"></i> Solicitações</a></li>
                </ul>
            </nav>
            <div class="user-info" id="userInfo" style="display:none;">
                <img src="https://randomuser.me/api/portraits/lego/1.jpg" alt="Funcionário">
                <span id="func_name"></span>
                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </header>    

    <!-- Dashboard do Funcionário (inicialmente oculto) -->
    <div class="employee-dashboard" id="employeeDashboard" style="display:none;">
        <h1 class="section-title" id="welcomeTitle">Bem-vindo!</h1>
        
        <section class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Coletas Disponíveis</h3>
                    <div class="card-icon"><i class="fas fa-list"></i></div>
                </div>
                <div class="card-content" id="availableCollects">0</div>
                <div class="card-footer" id="availableUpdated"><i class="fas fa-sync-alt"></i> Carregando...</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Coletas Aceitas</h3>
                    <div class="card-icon"><i class="fas fa-check-circle"></i></div>
                </div>
                <div class="card-content" id="acceptedCollects">0</div>
                <div class="card-footer" id="acceptedUpdated"><i class="fas fa-clock"></i> Carregando...</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Coletas Finalizadas</h3>
                    <div class="card-icon"><i class="fas fa-flag-checkered"></i></div>
                </div>
                <div class="card-content" id="completedCollects">0</div>
                <div class="card-footer" id="completedUpdated"><i class="fas fa-calendar"></i> Carregando...</div>
            </div>
        </section>

        <section id="coletas">
            <h2 class="section-title">Coletas Disponíveis</h2>
            <div class="table-responsive">
                <table id="coletasTable">
                    <thead>
                        <tr>
                            <th>ID</th><th>Descrição</th><th>Local</th><th>Anexo</th><th>Data</th><th>Status</th><th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="availableCollectsBody"></tbody>
                </table>
            </div>
        </section>
        
        <section id="minhas-coletas">
            <h2 class="section-title">Minhas Coletas</h2>
            <div class="table-responsive">
                <table id="myCollectsTable">
                    <thead>
                        <tr>
                            <th>ID</th><th>Descrição</th><th>Local</th><th>Anexo</th><th>Data</th><th>Status</th><th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="myCollectsBody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <footer>...seu footer...</footer>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <div class="notification-content">
            <div class="notification-title">Atenção!</div>
            <div id="notificationMessage">Operação realizada com sucesso!</div>
        </div>
    </div>

    <script>
    ;(async function(){
      const baseUrl = 'http://ec2-54-89-223-177.compute-1.amazonaws.com:3000';
      const token   = localStorage.getItem('token');
      if(!token) return window.location.href='login.html';

      const nav     = document.getElementById('employeeNav');
      const info    = document.getElementById('userInfo');
      const dash    = document.getElementById('employeeDashboard');
      const logout  = document.getElementById('logoutBtn');
      const welcome = document.getElementById('welcomeTitle');
      const cards = {
        avail: document.getElementById('availableCollects'),
        acc:   document.getElementById('acceptedCollects'),
        comp:  document.getElementById('completedCollects')
      };
      const foot = {
        avail: document.getElementById('availableUpdated'),
        acc:   document.getElementById('acceptedUpdated'),
        comp:  document.getElementById('completedUpdated')
      };
      const tbodyAvail = document.getElementById('availableCollectsBody');
      const tbodyMine  = document.getElementById('myCollectsBody');
      const notif      = document.getElementById('notification');
      const msg        = document.getElementById('notificationMessage');

      nav.style.display       = 'block';
      info.style.display      = 'flex';
      dash.style.display      = 'block';

      const payload = JSON.parse(atob(token.split('.')[1]||'{}'));
      document.getElementById('func_name').textContent = payload.email;
      welcome.textContent = `Bem-vindo, ${payload.email}!`;
      logout.onclick = ()=>{ localStorage.removeItem('token'); location='login.html'; };

      const headers = { 'Content-Type':'application/json','Authorization':`Bearer ${token}` };
      const fmt = d=> new Date(d).toLocaleString();

      async function loadAll(){
        // clear tables
        tbodyAvail.innerHTML = '';
        tbodyMine.innerHTML  = '';
        // fetch avail
        const r1 = await fetch(`${baseUrl}/solicitacoes/elegiveis`,{headers});
        const avail = r1.ok?await r1.json():[];
        cards.avail.textContent = avail.length;
        foot.avail.innerHTML    = `<i class="fas fa-sync-alt"></i> ${fmt(Date.now())}`;
        avail.forEach(i=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i.id}</td><td>${i.descricao}</td>
            <td>${i.rua}, ${i.numero} – ${i.bairro}/${i.cidade}-${i.estado}</td>
            <td>${i.imagem_url||'-'}</td>
            <td>${fmt(i.criado_em)}</td><td>${i.status}</td>
            <td><button data-act="aceitar" data-id="${i.id}" class="btn btn-accept"><i class="fas fa-check-circle"></i></button></td>`;
          tbodyAvail.appendChild(tr);
        });
        // fetch mine
        const r2 = await fetch(`${baseUrl}/solicitacoes/prestador/minhas`,{headers});
        const mine = r2.ok?await r2.json():[];
        const acc  = mine.filter(x=>x.status==='aceita');
        const cmp  = mine.filter(x=>x.status==='concluida');
        cards.acc.textContent  = acc.length;
        foot.acc.innerHTML     = `<i class="fas fa-clock"></i> ${fmt(Date.now())}`;
        cards.comp.textContent = cmp.length;
        foot.comp.innerHTML    = `<i class="fas fa-calendar"></i> ${fmt(Date.now())}`;
        mine.forEach(i=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i.id}</td><td>${i.descricao}</td>
            <td>${i.rua}, ${i.numero} – ${i.bairro}/${i.cidade}-${i.estado}</td>
            <td>${i.imagem_url||'-'}</td>
            <td>${fmt(i.criado_em)}</td><td>${i.status}</td>
            <td>${i.status==='aceita'
              ? `<button data-act="finalizar" data-id="${i.id}" class="btn btn-accept"><i class="fas fa-flag-checkered"></i></button>
                 <button data-act="cancelar" data-id="${i.id}" class="btn btn-reject"><i class="fas fa-times-circle"></i></button>`
              : '—'}</td>`;
          tbodyMine.appendChild(tr);
        });
      }

      document.body.addEventListener('click',async e=>{
        const b = e.target.closest('button[data-act]');
        if(!b)return;
        const id = b.dataset.id, a=b.dataset.act;
        let url, m='POST', body;
        if(a==='aceitar'){url=`${baseUrl}/solicitacoes/prestador/aceitar`; body=JSON.stringify({solicitacao_id:+id});}
        if(a==='finalizar'){url=`${baseUrl}/solicitacoes/prestador/${id}/finalizar`; m='PATCH';}
        if(a==='cancelar'){url=`${baseUrl}/solicitacoes/prestador/${id}/cancelar`; m='PATCH';}
        const opts={method:m,headers}; if(body)opts.body=body;
        const res = await fetch(url,opts);
        if(res.ok){ msg.textContent='Sucesso!'; notif.classList.add('show','success'); setTimeout(()=>notif.classList.remove('show','success'),3000); await loadAll(); }
        else { const ejs=await res.json().catch(()=>{}); msg.textContent=ejs?.message||'Erro'; notif.classList.add('show','error'); setTimeout(()=>notif.classList.remove('show','error'),3000); }
      });

      await loadAll();
    })();
    </script>
</body>
</html>
